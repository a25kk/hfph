<metal:block metal:define-macro="postView">
  <div class="forumPost"
       tal:define="view_post_actions view_post_actions | python:forum_add_post_permission">
    <h3>
       <a class="noborder"
          href=""
          tal:define="post_url post_item/url;"
          tal:attributes="href string:$post_url?view_details=1" >
        <img tal:attributes="src string:$portal_url/discussionitem_icon.gif" />
        <span tal:replace="post_item/title">Comment title</span>
       </a>
    </h3> 
    <div class="forumPostByLine" >
      <tal:info define="anonymous_author post_item/anonymous">
        <span i18n:translate="label_posted_by">Posted by</span>
        <tal:name condition="not:anonymous_author"
                  define="creator post_item/author;
                          author python:mtool.getMemberInfo(creator)">
          <a href="#"
             tal:attributes="href string:${portal_url}/author/${creator}"
             tal:content="python:author and author['fullname'] or creator"
             tal:omit-tag="not:author">
            Bob Dobalina
          </a>
        </tal:name>              
        <span i18n:translate="label_anonymous_user"
              tal:condition="anonymous_author">Anonymous User</span>
        <span i18n:translate="label_posted_at">at</span> 
        <span tal:replace="python:toLocalizedTime(post_item['created'], long_format=1)">
          8/23/2001 12:40:44 PM
        </span>
      </tal:info>   

      <span>            
        <a href=""
           class="forumPostLink"
           tal:condition="view_post_actions"
           tal:attributes="href string:${post_item/url}/createPost"
           i18n:translate="label_reply">
          Reply
        </a>
        &nbsp;
        <a href=""
           class="forumPostLink"
           tal:condition="view_post_actions"
           tal:attributes="href string:${post_item/url}/createPost?quote:boolean=True"
           i18n:translate="label_reply_with_quote">
          Reply with quote
        </a>
      </span>
    </div>
    
    <tal:block tal:define="post python:sftool.getObjectFromPath(post_item['path'])">
      <div class="forumPostBody"
           tal:content="structure post/getText" />   
    </tal:block>
  </div>
</metal:block>

<metal:block metal:define-macro="postThread"
             i18n:domain="simpleforum">
  <tal:block tal:define="post_items python:here.wrapPostItemsInThread(post_items)">
    <metal:block metal:use-macro="forum_macros/recursivePostThread" />
  </tal:block>
</metal:block>

<metal:block metal:define-macro="postInline"
             i18n:domain="simpleforum">
  <tal:block tal:define="Batch python:modules['Products.CMFPlone'].Batch;
                         b_size python:20;
                         b_start python:request.get('b_start', 0);
                         batch_macros nocall:here/batch_macros/macros;
                         batch python:Batch(post_items, b_size, int(b_start), orphan=1);">
    <!-- Navigation -->
    <div metal:use-macro="batch_macros/navigation" />
    <tal:block tal:repeat="post_item batch">
      <metal:block metal:use-macro="forum_macros/postView" />
    </tal:block>
    <!-- Navigation -->
    <div metal:use-macro="batch_macros/navigation" />
  </tal:block>
</metal:block>

<metal:block metal:define-macro="recursivePostThread"
             i18n:domain="simpleforum">
  <tal:block tal:condition="post_items">
    <div class="forumPostThread">
      <tal:block tal:repeat="post_item post_items">
        <metal:block metal:use-macro="forum_macros/postView" />
        <tal:block tal:define="post_items python:post_item.get('children', [])">
          <blockquote tal:condition="post_items">
          <metal:block metal:use-macro="forum_macros/recursivePostThread" />
          </blockquote>
        </tal:block>
      </tal:block>
    </div>
  </tal:block>
</metal:block>
