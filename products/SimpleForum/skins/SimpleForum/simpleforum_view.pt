<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
      lang="en"
      metal:use-macro="here/main_template/macros/master"
      i18n:domain="simpleforum">

<head>
  <metal:css fill-slot="css_slot">
    <style type="text/css" media="all"
           tal:content="string:@import url($portal_url/simpleforum.css);"></style>
  </metal:css>
    
  <metal:block fill-slot="top_slot"
               tal:define="mtool nocall:context/portal_membership;"
               tal:condition="python:(not mtool.checkPermission('Modify portal content', here)) and not mtool.checkPermission('Review portal content', here)">
    <tal:noborderset tal:define="dummy python:request.set('disable_border', 1)" />
  </metal:block>
</head>

<body>

<metal:main fill-slot="main">
  <tal:main-macro metal:define-macro="main"
                  tal:define="topic_items here/getTopicItems;
                              Batch python:modules['Products.CMFPlone'].Batch;
                              b_size python:20;
                              b_start python:request.get('b_start', 0);
                              batch_macros nocall:here/batch_macros/macros;
                              batch python:Batch(topic_items, b_size, int(b_start), orphan=1);
                              toLocalizedTime nocall:portal/toLocalizedTime;
                              forum_add_post_permission python:checkPermission('SimpleForum: Add Post', here);">
  
  <h1 tal:content="here/title_or_id" />

	<div metal:use-macro="here/document_byline/macros/byline">
	    Get the byline - contains details about author and modification date.
	</div>

  <a href=""
     class="link-parent"
     tal:define="parent_url python:here.navigationParent(here, template_id)"
     tal:condition="parent_url"
     i18n:domain="plone"
     tal:attributes="href parent_url"
     i18n:translate="go_to_parent_url">
    Up one level
  </a>
  
  <div class="documentDescription"
       tal:content="here/Description" />

  <h2 i18n:domain="simpleforum" 
      i18n:translate="heading_forum_view">
    Discussions
  </h2>

  <a class="forumTopicLink"
     tal:condition="forum_add_post_permission"
     tal:attributes="href string:$here_url/createPost"
     i18n:domain="simpleforum"
     i18n:translate="" >
    Add new topic
  </a>

  <!-- Navigation -->
  <div metal:use-macro="batch_macros/navigation" />	    
  <table class="listing" 
         style="width: 100%"
         tal:condition="topic_items">
  <thead>
    <tr>
      <th i18n:translate="label_topic_title"
          class="nosort">Topic</th>
      <th i18n:translate="label_topic_author"
          class="nosort">Author</th>
      <th i18n:translate="label_topic_date"
          class="nosort">Posted on</th>
      <th i18n:translate="label_topic_replies"
          class="nosort">Replies</th>
      <th i18n:translate="label_topic_action"
          class="nosort"
          tal:condition="forum_add_post_permission">Action</th>
    </tr>
  </thead>
  <tbody>
    <tal:loop tal:repeat="topic_item batch">
      <tr tal:define="topic_url topic_item/url;
                      anonymous_author topic_item/anonymous;
                      topic_created topic_item/created;
                      topic_title topic_item/title;
                      topic_posts_count topic_item/posts_count" >
        
        <td>
          <a tal:attributes="href topic_url"
             tal:content="topic_title" />
        </td>
        <td>
          <tal:name condition="not:anonymous_author"
                    define="creator topic_item/author;
                            author python:mtool.getMemberInfo(creator)">
            <a href="#"
               tal:attributes="href string:${portal_url}/author/${creator}"
               tal:content="python:author and author['fullname'] or creator"
               tal:omit-tag="not:author">
              Bob Dobalina
            </a>
          </tal:name>              
          <span i18n:translate="label_anonymous_user"
                tal:condition="anonymous_author">Anonymous User</span>        
        </td>
        <td tal:content="python:toLocalizedTime(topic_created, 1)" />
        <td>          
          <tal:block tal:condition="python:topic_posts_count == 0">
            <span i18n:translate="label_no_reply">no reply</span>
          </tal:block>     
          <tal:block tal:condition="python:topic_posts_count == 1">
            <span i18n:translate="label_reply_count"><span i18n:name="count">1</span> reply</span>
          </tal:block>
          <tal:block tal:condition="python:topic_posts_count > 1">
            <span i18n:translate="label_replies_count"><span i18n:name="count" tal:replace="topic_posts_count" /> replies</span>
          </tal:block>
        </td>
        <td tal:condition="forum_add_post_permission">
          <a href="" tal:attributes="href string:$topic_url/createPost"
                     title="Reply to this topic"
                     i18n:attributes="title">
          <span i18n:translate="label_reply">Reply</span>
          </a>
        </td>
      </tr>
    </tal:loop>
  </tbody>
  </table>
  <!-- Navigation -->
  <div metal:use-macro="batch_macros/navigation" />          
  </tal:main-macro>
</metal:main>
</body>
</html>
